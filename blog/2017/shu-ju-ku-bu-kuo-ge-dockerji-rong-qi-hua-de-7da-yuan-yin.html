<!DOCTYPE html><html xmlns="https://www.w3.org/1999/xhtml" xmlns:og="https://ogp.me/ns#" lang="zh" id="doc" class="no-js"><head><title>数据库不适合Docker及容器化的7大原因 |虞双齐Golang开发与SRE运维</title><meta name="description" content="导读：所有的服务都开始了容器化升级，在一切皆容器的主流思想下，无状态的服务采用容器化已经是大势所趋，"><meta name="keywords" content="golang, "><meta name="author" content="虞双齐"><meta name="generator" content="Hugo 0.17"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/img/app-icon64x64@2x.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Ysqi"><link rel="apple-touch-icon-precomposed" href="/img/app-icon64x64@2x.png"><meta name="msapplication-TileImage" content="/img/app-icon64x64@2x.png"><meta name="msapplication-TileColor" content="#0e90d2"><meta property="og:site_name" content="虞双齐Golang开发与SRE运维"><meta property="og:locale" content="zh"><meta property="og:url" content="https://yushuangqi.com/blog/2017/shu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html"><meta property="og:title" content="数据库不适合Docker及容器化的7大原因"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-02-18 11:13:42"><meta property="article:modified_time" content="2017-02-18 11:13:42"><meta property="article:tag" content="golang"><meta name="og:description" content="导读：所有的服务都开始了容器化升级，在一切皆容器的主流思想下，无状态的服务采用容器化已经是大势所趋，"><link rel="stylesheet" type="text/css" href="/css/jiandan.css?v=20170207"><script type="text/javascript">var doc = document.getElementById('doc');
	doc.removeAttribute('class', 'no-js');
	doc.setAttribute('class', 'js');</script><script type="text/javascript">var changeActive = function() {
		var page = document.getElementById("page");		
		if (page.getAttribute("class") === "not-active") {
			page.setAttribute("class", "active-sidebar");		
		} else if (page.getAttribute("class") === "active-sidebar") {
			page.setAttribute("class", "not-active");
		}		
	}
	
	window.onload = function() {
		if(document.getElementById("sidebar-button")) {
			var sidebar_button = document.getElementById("sidebar-button");
			sidebar_button.onclick = function(event) {
				changeActive();
				event.preventDefault();
			}
		}
		
	}
	
	window.onresize = function() {
		var page = document.getElementById("page");	
		page.setAttribute("class", "not-active");	
	}</script></head><body id="page" class="not-active"><div class="container"><header class="header writingsheader"><nav class="off-canvas-nav-links"><ul><li class="menuli"><a class="menubutton" href="#menu">Menu</a></li><li id="site-title"><a class="menulogo" id="sidebar-button" href="#sidebar">附件信息</a></li></ul></nav></header><section role="main"><article class="entry writingsentry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 itemprop="headline"><a rel="bookmark" href="https://yushuangqi.com/blog/2017/shu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html">数据库不适合Docker及容器化的7大原因</a></h1><p class="attribution"><span itemprop="author"><span itemscope itemtype="http://schema.org/Person">文/ <a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;amp;mid=2653548247&amp;amp;idx=1&amp;amp;sn=99d0e90fa99deec3a7dab49eac418e5c&amp;amp;scene=0" rel="nofollow" target="_blank">属转载,查看原文 <span itemprop="name" style="display:none">虞双齐</span></a></span> </span><span class="right"><time itemprop="datePublished" datetime="2017-02-18">2017年02月18日</time></span></p></header><div itemprop="articleBody"><p>导读：所有的服务都开始了容器化升级，在一切皆容器的主流思想下，无状态的服务采用容器化已经是大势所趋，常常困扰架构师的一个问题是，数据库是否需要容器化，本文作者 Mikhail Chinkov 提出了自己否定观点，由高可用架构翻译。</p><p></p><p>如果我们观察 2017 年技术行业，容器和 Docker 依然将是最热门的流行语。我们开始在每个领域的 Docker 容器中打包开发的软件。从小型初创公司到巨大的微服务平台都在使用容器技术。从 CI 平台到 Raspberry Pi 。从数据库到……<br><br>数据库？您确定要将数据库放在容器中吗？<br><br>不幸的是，这不是虚构的场景。我看到许多快速增长的项目将数据持久化到容器中。并且将计算服务和数据服务放在同一台机器上。笔者希望有经验的人不会用这个解决方案。<br><br>下面是我的观点，数据库容器化从今天来看是非常不合理的。<br></p><h2 id="数据库不适合容器化的7大原因"><strong>数据库不适合容器化的7大原因</strong></h2><p>**<br>**</p><h3 id="1-数据不安全"><strong>1. 数据不安全</strong></h3><p></p><p>即使你要把 Docker 数据放在主机来存储 ，它依然不能保证不丢数据。 Docker volumes 的设计围绕 Union FS 镜像层提供持久存储，但它仍然缺乏保证。<br><br>使用当前的存储驱动程序，Docker 仍然存在不可靠的风险。 如果容器崩溃并数据库未正确关闭，则可能会损坏数据。</p><p></p><h3 id="2-运行数据库的环境需求"><strong>2. 运行数据库的环境需求</strong></h3><p>**<br>**</p><p>常看到 DBMS 容器和其他服务运行在同一主机上。 然而这些服务对硬件要求是非常不同的。<br><br>数据库（特别是关系型数据库）对 IO 的要求较高。 一般数据库引擎为了避免并发资源竞争而使用专用环境。如果将你的数据库放在容器中，那么将浪费你的项目的资源。 因为你需要为该实例配置大量额外的资源。 在公有云，当你需要 34G 内存时，你启动的实例却必须开 64G 内存。在实践中，这些资源并未完全使用。<br><br>怎么解决？ 您可以分层设计，并使用固定资源来启动不同层次的多个实例。 水平伸缩总是比垂直伸缩更好。</p><p></p><h3 id="3-网络问题"><strong>3. 网络问题</strong></h3><p>**<br>**</p><p>要理解 Docker 网络，您必须对网络虚拟化有深入的了解。也必须准备应付好意外情况。你可能需要在没有支持或没有额外工具的情况下，进行 bug 修复。<br><br>我们知道：数据库需要专用的和持久的吞吐量，以实现更高的负载。我们还知道容器是虚拟机管理程序和主机虚拟机背后的一个隔离层。然而网络对于数据库复制是至关重要的，其中需要主从数据库间 <sup>24</sup>&frasl;<sub>7</sub> 的稳定连接。未解决的 Docker 网络问题在1.9版本依然没有得到解决。<br><br>把这些问题放在一起，容器化使数据库容器很难管理。我知道你是一个顶级的工程师，什么问题都可以得到解决。但是，你需要花多少时间解决 Docker 网络问题？将数据库放在专用环境不会更好吗？节省时间来专注于真正重要的业务目标。</p><p></p><h3 id="4-状态"><strong>4. 状态</strong></h3><p>**<br>**</p><p>在 Docker 中打包无状态服务是很酷的，可以实现编排容器并解决单点故障问题。 但是数据库呢？ 将数据库放在同一个环境中，它将会是有状态的，并使系统故障的范围更大。下次您的应用程序实例或应用程序崩溃，可能会影响数据库。</p><p></p><h3 id="5-数据库不适合使用主要的-docker-功能"><strong>5. 数据库不适合使用主要的 Docker 功能</strong></h3><p>**<br>**</p><p>考虑容器中的数据库，我们来思考它的价值。 我们先看看 Docker 官方对其的定义：</p><p></p><blockquote><p>Docker 是为开发人员和系统管理员构建，分发和运行分布式应用程序的开放平台。 Docker 包括 Docker Engine（便携式，轻量级运行时和打包工具）以及 Docker Hub（用于共享应用程序和自动化工作流的云服务），Docker 使应用程序能够以组件快速组装，并消除开发，QA 和生产环境之间的不同。 因此，IT 可以更快地分发程序，并在笔记本电脑，数据中心虚拟机和任何云上运行相同的应用程序。</p></blockquote><p><br>根据该答案，我们可以很容易定义 Docke r的主要特性：</p><p></p><ul><li><p>易于构建新环境</p></li><li><p>易于重新部署（持续集成）</p></li><li><p>容易水平伸缩（从实践得出）</p></li><li><p>易于维护环境一致</p></li></ul><p></p><p>让我们开始思考这些功能如何适应数据库世界。<br><br>容易设置数据库？ 让我们看看，容器化或者在本地运行数据库，在运行上是否有巨大的差异。</p><pre><code>docker run -d mongod:3.4
</code></pre><p>对比：</p><pre><code>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6echo &quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.listsudo apt-get update &amp;&amp; sudo apt-get install -y mongodb-org
</code></pre><p></p><p>易于构建新环境？如果我们谈论是 MongoDB集群 - 可能容器化效率更高。但是配置管理系统呢？它们旨在通过运行一个命令来解决配置问题。使用 Ansible 你可以轻松设置几十个 Mongo 实例。正如你所看到的，没有显著的价值增长。<br><br>容易重新部署？您重新部署数据库升级到下一个版本的频率是多少呢？数据库升级不是可用性问题，而是工程问题（即在群集中的可用性）。想想你的应用程序将如何使用新的数据库引擎版本。引擎更换时可能导致的问题。<br><br>容易水平伸缩？是否要在多个实例之间共享数据目录？你不害怕直接数据并发问题和可能的数据损坏吗？使用专用数据环境部署多个实例不会更安全吗？最后搞一个主从复制？<br><br>易于维护环境一致？数据库实例环境的变化频率如何？每天升级操作系统吗？还是数据库版本或依赖软件变化频繁？或者是不容易与工程团队达成共识？<br><br>最后看来，没有一个特性足以让我考虑数据库容器化。</p><p></p><h3 id="6-额外的隔离对数据库是不利的"><strong>6. 额外的隔离对数据库是不利的</strong></h3><p></p><p>其实我在第二点和第三点原因中提到了这一点。 但我把这个列为单独的原因，因为我想再次强调这一事实。 我们拥有的隔离级别越多，我们获得的资源开销就越多。 相比专用环境而言，容易水平伸缩可以使我们得到更多的好处。 然而<strong>在 Docker 中水平伸缩只能用于无状态计算服务，而不是数据库。</strong><br><br>我们没有看到任何针对数据库的隔离功能，那为什么我们应该把它放在容器中？</p><p></p><h3 id="7-云平台的不适用性"><strong>7. 云平台的不适用性</strong></h3><p>**<br>**</p><p>大部分人通过共有云开始项目。 云简化了虚拟机操作和替换的复杂性，因此不需要在夜间或周末没有人工作时间来测试新的硬件环境。当我们可以迅速启动一个实例的时候，为什么我们需要担心这个实例运行的环境？<br><br>这就是为什么我们向云提供商支付很多费用的原因。 当我们为实例放置数据库容器时，上面说的这些便利性就不存在了。因为数据不匹配，新实例不会与现有的实例兼容，如果要限制实例使用单机服务，应该让 DB 使用非容器化环境，我们仅仅需要为计算服务层保留弹性扩展的能力。</p><p></p><h2 id="这-7-点适用于所有数据库吗"><strong>这 7 点适用于所有数据库吗？</strong></h2><p>**<br>**</p><p>也许不是全部，但是应该是一切需要持久化数据的数据库，以及所有具有特殊硬件环境要求的数据库。<br><br>如果我们使用 Redis 作为缓存或用户会话存储- 使用容器就不应该有任何问题。因为不需要保证该数据落地，那么数据没有丢失的风险。但是如果我们考虑使用 Redis 作为一个持久的数据存储，那么你最好把数据放在容器外面，即使您不断刷新 RDB 快照，在快速变化的计算集群中找到这个快照也会很复杂。<br><br>我们还可以谈谈容器内的 Elasticsearch。我们可以存储在 ES 中的索引，并且可以从持久性数据源重建它们。但是看看要求！默认情况下，Elasticsearch 需要 2 到 3GB 的内存。由于 Java 的 GC，内存使用并不一致。您确定Elasticsearch 适合用于资源限制的容器吗？让不同的 Elasticsearch 实例使用不同的硬件配置不是更好吗？<br><br>不要担心本地开发环境的数据库容器化。将数据库放在本地环境的容器中，你将节省大量的时间和精力。你将能够复制生产环境操作系统。原生Postgres for OS X或Windows不是100％兼容Linux版本。在主机操作系统上设置容器而不是软件包，你会克服这种问题。</p><p></p><h2 id="结论"><strong>结论</strong></h2><p>**<br>**</p><p>Docker 的炒作应该有一天会冷下来。 这并不意味着人们将停止使用容器虚拟化技术，而是说我们在将容器化设计时，需要将其带来的价值放在首要考量因素。<br><br>几天前我看到了一个关于在零乱的 Ruby 世界中框架如何生存的演讲。 从这个演讲中我得到的启发是技术炒作周期，借用这个炒作周期的说法，我们看到 Docker 目前在第二阶段（充满期望的高峰）太长时间（高可用架构小编：参看资源1），当我们在最后一个阶段看到 Docker 时，情况将会正常化。 我认为我们需要对这种过程负责，并应该加快这一进程。</p><p></p><p><strong>参考资源</strong></p><p></p><ol><li><p><a href="https://www.youtube.com/watch?v=9zc4DSTRGeM#7m40s">https://www.youtube.com/watch?v=9zc4DSTRGeM#7m40s</a></p></li><li><p>英文原文：<a href="https://myopsblog.wordpress.com/2017/02/06/why-databases-is-not-for-containers/">https://myopsblog.wordpress.com/2017/02/06/why-databases-is-not-for-containers/</a></p></li></ol><p></p><p><strong>推荐阅读</strong></p><p></p><ul><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548216&amp;idx=1&amp;sn=30d4fdf2c06734c06bf857c513c9d49a&amp;chksm=813a7f20b64df6362d0e9e32516141b0f4bc860ecb0a9d132c144b4c00845a4151216ff2f7d4&amp;scene=21">一场技术人的年终盛典：9个老兵对2016年总结与思考</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547942&amp;idx=1&amp;sn=6683987febfe0812a705d4c95409fd89&amp;chksm=813a7c3eb64df5289ebb70bcf14fefe8ad248949350d6d861600c51d87a41dd06ba924f2f24c&amp;scene=21">一键搭建深度学习平台，基于Docker/Mesos和NVIDIA GPU详细教程</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547795&amp;idx=1&amp;sn=2074c6156db9f1249ee3f8cdc73ae73e&amp;chksm=813a7c8bb64df59d870a4f9e248958f2a121415f7f5f69a171729925cc9dc70c9ba75446b54a&amp;scene=21">Docker存储方式选型建议</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=403508930&amp;idx=1&amp;sn=2b04c3d1dca80624f091a188f9772301&amp;scene=21">Joyent CTO谈容器在2016年亟需改变的问题</a></p></li></ul><p></p><p>本文最初出现在（<a href="http://myopsblog.wordpress.com/），由高可用架构翻译，转载请注明出处，技术原创及架构实践文章，欢迎通过公众号菜单「联系我们」进行投稿。">http://myopsblog.wordpress.com/），由高可用架构翻译，转载请注明出处，技术原创及架构实践文章，欢迎通过公众号菜单「联系我们」进行投稿。</a></p><p></p><p><strong>高可用架构</strong></p><p><strong>改变互联网的构建方式</strong></p><p>**<br>**长按二维码 关注「高可用架构」公众号</p><p></p></div><aside id="meta"><meta itemprop="wordCount" content="243"><meta itemprop="url" content="https://yushuangqi.com/blog/2017/shu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html"></aside></article><div><div class="attribution"><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a></div><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","tqq","tieba","douban","sqq","youdao","qingbiji","mail","evernotecn","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></div><div><ul class="rel_links"><li class="rel_linksli"><span id="topics">分类: <a href="/topics/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B8%8E%E5%BC%80%E5%8F%91.html" rel="category">编程语言与开发</a> </span><span id="tags">标签: <a href="/tags/golang.html" rel="tag">golang</a></span></li><li class="rel_linksli rel_prev"><a href="https://yushuangqi.com/blog/2017/diao-zha-tian-de-xin-ban-go-gczhi-twitchde-gcyou-hua-zhi-lu.html">屌炸天的新版GoGC之twitch的GC优化之路</a></li><li class="rel_linksli rel_next"><a href="https://yushuangqi.com/blog/2017/gozui-xin-de-depxiang-jie.html">Go最新的dep详解</a></li></ul></div><aside id="comments"><div><div class="ds-thread" data-thread-key="8c97e4b0ae375667ebd9aedcbd340512" data-title="数据库不适合Docker及容器化的7大原因" data-url="https://yushuangqi.com/blog/2017/shu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html"></div></div></aside><div><section id="author"><h4>About author</h4><p><strong>虞双齐</strong>，全栈开发工程师，Google SRE实践者。提供Golang开发、技术实践与架构等咨询服务。</p><p>动态分享到微博<a href="http://weibo.com/234665601" rel="nofollow">@虞双齐</a>，代码存放在 <a href="http://github.com/ysqi" rel="nofollow">Github</a>，博文分享在 <a href="https://yushuangqi.com" title="虞双齐Golang开发与SRE运维">个人博客</a>上。</p></section></div></div></section><section id="sidebar" role="complementary"><aside class="writings"><a href="/" class="sideimg sideimgwritings">Home</a> <q class="dquote">读书之法，莫贵于循序而致精。<cite>—宋·朱熹《性理精义》</cite></q><ul class="rel_links"><li class="rel_linksli"><a href="http://weibo.com/234665601" title="关注虞双齐的微博" rel="nofollow">我的微博</a></li><li class="rel_linksli"><a href="https://github.com/ysqi" title="访问虞双齐的Github" rel="nofollow">我的 Github</a></li></ul></aside><aside><div class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div></aside></section><nav id="menu" role="navigation"><ul id="nav" class="navlist"><li class="navtop"><a class="navtoplink" href="#page"><span>Top</span></a></li><li><a class="navabout" href="https://yushuangqi.com"><span>首页</span></a></li><li><a class="navwritings" href="/topics/"><span>博文</span></a></li><li><a class="navpresos" href="/book.html"><span>电子书</span></a></li><li><a class="navabout" href="/about.html"><span>关于我</span></a></li></ul></nav></div><footer class="site-footer"><ul class="footeractions"><li><a class="footeraction" href="http://weibo.com/234665601" rel="nofollow"><span class="footeractionWeibo">Follow on Weibo</span></a></li><li><a href="http://validator.w3.org/check?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2017%2fshu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-html401.png" alt="Valid XHTMl 4.0"></a></li><li><a href="http://jigsaw.w3.org/css-validator/validator?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2017%2fshu-ju-ku-bu-kuo-ge-dockerji-rong-qi-hua-de-7da-yuan-yin.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-css2.png" alt="Valid XHTMl 4.0"></a></li></ul><p>©2015-2016 虞双齐-#Golang开发 #SRE运维。欢迎<a href="/about.html" rel="nofollow">联系我</a>，<a href="http://www.miitbeian.gov.cn/" target="bank" rel="nofollow" style="color:#c9c9c9">粤ICP备14032560号-4</a></p></footer><script type="text/javascript">var duoshuoQuery = {short_name:"ysqi"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-44627932-2', 'auto');
  ga('send', 'pageview');</script></body></html>