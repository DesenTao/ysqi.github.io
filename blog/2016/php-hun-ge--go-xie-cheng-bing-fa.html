<!DOCTYPE html><html xmlns="https://www.w3.org/1999/xhtml" xmlns:og="https://ogp.me/ns#" lang="zh" id="doc" class="no-js"><head><title>PHP混合Go协程并发 |极客虞双齐</title><meta name="description" content="想法很简单。通过设置 runtime.GOMAXPROCS(1) 让 golang 的进程变成单线程"><meta name="keywords" content="php, golang, coroutine, "><meta name="author" content="虞双齐"><meta name="generator" content="Hugo 0.17"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="32x32" href="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="虞双齐"><link rel="apple-touch-icon-precomposed" href="/img/app-icon64x64.png"><meta name="msapplication-TileImage" content="/img/app-icon128x128.png"><meta name="msapplication-TileColor" content="#0e90d2"><meta property="og:site_name" content="极客虞双齐"><meta property="og:locale" content="zh"><meta property="og:url" content="https://yushuangqi.com/blog/2016/php-hun-ge--go-xie-cheng-bing-fa.html"><meta property="og:title" content="PHP混合Go协程并发"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-12-31 11:32:57"><meta property="article:modified_time" content="2016-12-31 11:32:57"><meta property="article:tag" content="php"><meta property="article:tag" content="golang"><meta property="article:tag" content="coroutine"><meta name="og:description" content="想法很简单。通过设置 runtime.GOMAXPROCS(1) 让 golang 的进程变成单线程"><link rel="stylesheet" type="text/css" href="/css/jiandan.css?v=20170207"><script type="text/javascript">var doc = document.getElementById('doc');
	doc.removeAttribute('class', 'no-js');
	doc.setAttribute('class', 'js');</script><script type="text/javascript">var changeActive = function() {
		var page = document.getElementById("page");		
		if (page.getAttribute("class") === "not-active") {
			page.setAttribute("class", "active-sidebar");		
		} else if (page.getAttribute("class") === "active-sidebar") {
			page.setAttribute("class", "not-active");
		}		
	}
	
	window.onload = function() {
		if(document.getElementById("sidebar-button")) {
			var sidebar_button = document.getElementById("sidebar-button");
			sidebar_button.onclick = function(event) {
				changeActive();
				event.preventDefault();
			}
		}
		
	}
	
	window.onresize = function() {
		var page = document.getElementById("page");	
		page.setAttribute("class", "not-active");	
	}</script></head><body id="page" class="not-active"><div class="container"><header class="header writingsheader"><nav class="off-canvas-nav-links"><ul><li class="menuli"><a class="menubutton" href="#menu">Menu</a></li><li id="site-title"><a class="menulogo" id="sidebar-button" href="#sidebar">附件信息</a></li></ul></nav></header><section role="main"><article class="entry writingsentry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 itemprop="headline"><a rel="bookmark" href="https://yushuangqi.com/blog/2016/php-hun-ge--go-xie-cheng-bing-fa.html">PHP混合Go协程并发</a></h1><p class="attribution"><span itemprop="author"><span itemscope itemtype="http://schema.org/Person">文/ <a href="https://segmentfault.com/a/1190000007299367" rel="nofollow" target="_blank">属转载,查看原文 <span itemprop="name" style="display:none">虞双齐</span></a></span> </span><span class="right"><time itemprop="datePublished" datetime="2016-12-31">2016年12月31日</time></span></p></header><div itemprop="articleBody"><p>想法很简单。通过设置 <code>runtime.GOMAXPROCS(1)</code> 让 golang 的进程变成单线程执行的。类似python用gevent的效果。然后通过调度多个协程实现异步I/O并发。php作为一个子函数跑在go的进程内，php需要yield到其他协程时，通过回调到golang函数来实现。从php里调用go提供的子函数时，go保证保存php的当前上下文。当协程执行权让渡回来的时候，把原来的php上下文恢复。关键的代码在：</p><div class="highlight" style="background:#f0f0f0"><pre style="line-height:125%"><span></span>    <span style="color:#60a0b0;font-style:italic">// 保存当前协程上的php上下文</span>
        oldServerCtx <span style="color:#666">:=</span> engine.ServerContextGet()
        fmt.Println(oldServerCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.ServerContextSet(oldServerCtx)
        oldExecutorCtx <span style="color:#666">:=</span> engine.ExecutorContextGet()
        fmt.Println(oldExecutorCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.ExecutorContextSet(oldExecutorCtx)
        oldCoreCtx <span style="color:#666">:=</span> engine.CoreContextGet()
        fmt.Println(oldCoreCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.CoreContextSet(oldCoreCtx)

    <span style="color:#60a0b0;font-style:italic">// 放弃全局的锁，使得其他的协程可以开始执行php</span>
        engineLock.Unlock()
        <span style="color:#007020;font-weight:700">defer</span> engineLock.Lock()
</pre></div><p>ServerContextGet 这几个函数是我加的，获得的是php的（EG/SG/PG）这三个全局context（参见：<a href="http://www.cnblogs.com/chance1/archive/2009/12/28/1634515.html">http://www.cnblogs.com/chance&hellip;</a>）。修改过的<code>github.com/deuill/go-php</code>的源代码在：<a href="https://github.com/taowen/go-php/commit/cfe707720bb4f3be60ae571fddfaa660194be9b5">https://github.com/taowen/go-&hellip;</a></p><p>完整的php/go混合协程的demo：</p><div class="highlight" style="background:#f0f0f0"><pre style="line-height:125%"><span></span>    <span style="color:#007020;font-weight:700">package</span> main

    <span style="color:#007020;font-weight:700">import</span> (
        <span style="color:#4070a0">&quot;fmt&quot;</span>
        <span style="color:#4070a0">&quot;github.com/deuill/go-php/engine&quot;</span>
        <span style="color:#4070a0">&quot;os&quot;</span>
        <span style="color:#4070a0">&quot;runtime&quot;</span>
        <span style="color:#4070a0">&quot;time&quot;</span>
        <span style="color:#4070a0">&quot;sync&quot;</span>
    )

    <span style="color:#007020;font-weight:700">type</span> TestObj <span style="color:#007020;font-weight:700">struct</span>{}

    <span style="color:#007020;font-weight:700">func</span> newTestObj(args []<span style="color:#007020;font-weight:700">interface</span>{}) <span style="color:#007020;font-weight:700">interface</span>{} {
        <span style="color:#007020;font-weight:700">return</span> <span style="color:#666">&amp;</span>TestObj{}
    }
    <span style="color:#007020;font-weight:700">var</span> engineLock <span style="color:#666">*</span>sync.Mutex

    <span style="color:#007020;font-weight:700">func</span> (self <span style="color:#666">*</span>TestObj) Hello() {
        oldServerCtx <span style="color:#666">:=</span> engine.ServerContextGet()
        fmt.Println(oldServerCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.ServerContextSet(oldServerCtx)
        oldExecutorCtx <span style="color:#666">:=</span> engine.ExecutorContextGet()
        fmt.Println(oldExecutorCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.ExecutorContextSet(oldExecutorCtx)
        oldCoreCtx <span style="color:#666">:=</span> engine.CoreContextGet()
        fmt.Println(oldCoreCtx)
        <span style="color:#007020;font-weight:700">defer</span> engine.CoreContextSet(oldCoreCtx)
        engineLock.Unlock()
        <span style="color:#007020;font-weight:700">defer</span> engineLock.Lock()
        time.Sleep(time.Second)
        fmt.Println(<span style="color:#4070a0">&quot;sleep done&quot;</span>)
    }

    <span style="color:#007020;font-weight:700">func</span> main() {
        runtime.GOMAXPROCS(<span style="color:#40a070">1</span>)
        theEngine, err <span style="color:#666">:=</span> engine.New()
        engineLock = <span style="color:#666">&amp;</span>sync.Mutex{}
        <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
            fmt.Println(err)
        }
        _, err = theEngine.Define(<span style="color:#4070a0">&quot;TestObj&quot;</span>, newTestObj)
        wg <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>sync.WaitGroup{}
        wg.Add(<span style="color:#40a070">2</span>)
        before <span style="color:#666">:=</span> time.Now()
        fmt.Println(<span style="color:#4070a0">&quot;1&quot;</span>)
        <span style="color:#007020;font-weight:700">go</span> <span style="color:#007020;font-weight:700">func</span>() {
            engineLock.Lock()
            <span style="color:#007020;font-weight:700">defer</span> engineLock.Unlock()
            context1, err <span style="color:#666">:=</span> theEngine.NewContext()
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            context1.Output = os.Stdout
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            fmt.Println(<span style="color:#4070a0">&quot;1 enter&quot;</span>)
            _, err = context1.Eval(<span style="color:#4070a0">&quot;$testObj = new TestObj(); $testObj-&gt;Hello();&quot;</span>)
            fmt.Println(<span style="color:#4070a0">&quot;1 back&quot;</span>)
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            <span style="color:#60a0b0;font-style:italic">//theEngine.DestroyContext(context1)</span>
            fmt.Println(<span style="color:#4070a0">&quot;1 done&quot;</span>)
            wg.Done()
        }()
        fmt.Println(<span style="color:#4070a0">&quot;2&quot;</span>)
        <span style="color:#007020;font-weight:700">go</span> <span style="color:#007020;font-weight:700">func</span>() {
            engineLock.Lock()
            <span style="color:#007020;font-weight:700">defer</span> engineLock.Unlock()
            context2, err <span style="color:#666">:=</span> theEngine.NewContext()
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            context2.Output = os.Stdout
            fmt.Println(<span style="color:#4070a0">&quot;2 enter&quot;</span>)
            _, err = context2.Eval(<span style="color:#4070a0">&quot;$testObj = new TestObj(); $testObj-&gt;Hello();&quot;</span>)
            fmt.Println(<span style="color:#4070a0">&quot;2 back&quot;</span>)
            <span style="color:#007020;font-weight:700">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">nil</span> {
                fmt.Println(err)
            }
            <span style="color:#60a0b0;font-style:italic">//theEngine.DestroyContext(context2)</span>
            fmt.Println(<span style="color:#4070a0">&quot;2 done&quot;</span>)
            wg.Done()
        }()
        wg.Wait()
        after <span style="color:#666">:=</span> time.Now()
        fmt.Println(after.Sub(before))
    }
</pre></div><p>执行结果是</p><pre><code>    1
    2
    2 enter
    {0x2cf2930 {&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 0 [0 0 0 0 0] &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 &lt;nil&gt; 1000 [0 0 0 0]} \{\{&lt;nil&gt; &lt;nil&gt; 0 16 0x7f682e819780 0 [0 0 0 0 0 0 0] &lt;nil&gt;} 0 1 [0 0 0] &lt;nil&gt; &lt;nil&gt;} 0 0 0 [0 0 0 0 0 0] {0 0 0 0 0 0 0 0 0 0 0 {0 0} {0 0} {0 0} [0 0 0]} 0x2a00270 0x2a00f60 &lt;nil&gt; 8388608 0 1 [0 0 0] 0 {8 7 2 [0 0 0 0] 0 0x29f4520 0x29f4520 0x29f4470 0x29f4420 &lt;nil&gt; 1 0 0 [0 0 0 0 0]} &lt;nil&gt; {0 [0 0 0 0 0 0 0] &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;} 0 [0 0 0 0 0 0 0]}
    {0x7ffd30bac588 {[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] 2 0 0 [0 0]} 0x7f682f01b928 {[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] 1 0 0 [0 0]} 0x7f682f01b948 [&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;] 0x7f682f01ba60 0x7f682f01b960 0x7f682f167168 0x7f682f01ba88 {64 63 5 [0 0 0 0] 0 0x7f682f1972d8 0x7f682f1972d8 0x7f682f1993f8 0x7f682f1970c8 0x7f682e862d10 0 0 1 [0 0 0 0 0]} {8 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 &lt;nil&gt; 0 0 1 [0 0 0 0 0]} 0x7ffd30bac590 22527 0 0 [0 0 0 0] 0x7f682f197640 0x29f4f80 0x29f4fd0 0x29f5070 &lt;nil&gt; 0x2cf2950 0x7f682f1989c0 14 0 1 [0 0 0] &lt;nil&gt; &lt;nil&gt; 0 1 [0 0 0 0 0 0] {8 0 0 [0 0 0 0] 1 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 0x7f682e883140 0 0 1 [0 0 0 0 0]} {8 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 0x7f682e8831d0 1 0 0 [0 0 0 0 0]} 0x7f682f167088 0 [0 0 0 0] &lt;nil&gt; &lt;nil&gt; {0 0 &lt;nil&gt;} {0 0 &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0 0 0 0]} {0 0 &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0 0 0 0]} 0 [0 0 0 0] &lt;nil&gt; 0 0 0x29fb2e0 &lt;nil&gt; &lt;nil&gt; {0x7f682f187030 2 1024 -1 [0 0 0 0]} &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; [{0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8} {0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8} {0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8}] 0x7f682f167168 &lt;nil&gt; {0 [0 0 0 0] &lt;nil&gt; 0 [0 0 0 0] 0 0 [0 0 0 0] &lt;nil&gt; 0 [0 0 0 0] &lt;nil&gt;} 1 [0 0 0 0 0 0 0] &lt;nil&gt; 0x7f682f01bde8 895 [0 0 0 0 0 0] [&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;]}
    {1 [0 0 0 0 0 0 0] 0 0 0 [0 0 0 0 0 0] &lt;nil&gt; 0x29ff9a0 17 134217728 -1 0 0 0 1 [0 0 0 0] 1024 0 0 1 [0 0 0 0 0] 0x2a00870 &lt;nil&gt; 0x2a010a0 0x7f682ecc58b0 &lt;nil&gt; 0x7f682ecc5c23 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 2097152 &lt;nil&gt; &lt;nil&gt; 0x2a00180 0x2a00230 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; {0x7f682ec91aa8 0x7f682ec91aa8} 0x2a00910 {0 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 0 [0 0 0 0 0]} 0 0 0 [0 0 0] {0x2b6dc10 0x2b6dc10 1 8 &lt;nil&gt; 1 [0 0 0 0 0 0 0] &lt;nil&gt;} [0x7f682f197330 0x7f682f197040 0x7f682f197410 &lt;nil&gt; &lt;nil&gt; 0x7f682f1974f0] 0 1 1 [0 0 0 0 0] 0x7f682ec9544b 0x7f682ec9544b 0 0 [0 0 0 0 0 0] 0 [0 0 0 0 0 0 0 0] 1 1 1 1 1 0 1 [0] 0 [0 0 0 0] &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0] 0x2cf27c0 &lt;nil&gt; 0 0 [0 0 0 0 0 0] 64 1000 0 [0 0 0 0 0 0 0] 0x7f682ecc6270 300 0x2a009b0 1 [0 0 0 0 0 0 0] &lt;nil&gt; 0 [0 0 0 0 0 0 0]}
    1 enter
    {0x7f6818000aa0 {&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 0 [0 0 0 0 0] &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 &lt;nil&gt; 1000 [0 0 0 0]} \{\{&lt;nil&gt; &lt;nil&gt; 0 16 0x7f682e819780 0 [0 0 0 0 0 0 0] &lt;nil&gt;} 0 1 [0 0 0] &lt;nil&gt; &lt;nil&gt;} 0 0 0 [0 0 0 0 0 0] {0 0 0 0 0 0 0 0 0 0 0 {0 0} {0 0} {0 0} [0 0 0]} 0x2a00270 0x2a00f60 &lt;nil&gt; 8388608 0 1 [0 0 0] 0 {8 7 2 [0 0 0 0] 0 0x29f4520 0x29f4520 0x29f4470 0x29f4420 &lt;nil&gt; 1 0 0 [0 0 0 0 0]} &lt;nil&gt; {0 [0 0 0 0 0 0 0] &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;} 0 [0 0 0 0 0 0 0]}
    {0x7f682a4cccd8 {[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] 2 0 0 [0 0]} 0x7f682f01b928 {[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] 1 0 0 [0 0]} 0x7f682f01b948 [&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;] 0x7f682f01ba60 0x7f682f01b960 0x7f682802f110 0x7f682f01ba88 {64 63 5 [0 0 0 0] 0 0x7f682f197a00 0x7f682f197a00 0x7f682f198368 0x7f682f198fa0 0x7f682e862d10 0 0 1 [0 0 0 0 0]} {8 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 &lt;nil&gt; 0 0 1 [0 0 0 0 0]} 0x7f682a4ccce0 22527 0 0 [0 0 0 0] 0x7f682f197d28 0x29f4f80 0x29f4fd0 0x29f5070 &lt;nil&gt; 0x2cf2950 0x7f682f1983e8 14 0 1 [0 0 0] &lt;nil&gt; &lt;nil&gt; 0 1 [0 0 0 0 0 0] {8 0 0 [0 0 0 0] 1 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 0x7f682e883140 0 0 1 [0 0 0 0 0]} {8 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0x7f682f016a00 0x7f682e8831d0 1 0 0 [0 0 0 0 0]} 0x7f682802f030 0 [0 0 0 0] &lt;nil&gt; &lt;nil&gt; {0 0 &lt;nil&gt;} {0 0 &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0 0 0 0]} {0 0 &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0 0 0 0]} 0 [0 0 0 0] &lt;nil&gt; 0 0 0x29fb2e0 &lt;nil&gt; &lt;nil&gt; {0x7f682804efd8 2 1024 -1 [0 0 0 0]} &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; [{0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8} {0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8} {0x7f682e915050 [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] [0 0 0 0 0 0 0 0] 0 0 149 8 8 8}] 0x7f682802f110 &lt;nil&gt; {0 [0 0 0 0] &lt;nil&gt; 0 [0 0 0 0] 0 0 [0 0 0 0] &lt;nil&gt; 0 [0 0 0 0] &lt;nil&gt;} 1 [0 0 0 0 0 0 0] &lt;nil&gt; 0x7f682f01bde8 895 [0 0 0 0 0 0] [&lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt;]}
    {1 [0 0 0 0 0 0 0] 0 0 0 [0 0 0 0 0 0] &lt;nil&gt; 0x29ff9a0 17 134217728 -1 0 0 0 1 [0 0 0 0] 1024 0 0 1 [0 0 0 0 0] 0x2a00870 &lt;nil&gt; 0x2a010a0 0x7f682ecc58b0 &lt;nil&gt; 0x7f682ecc5c23 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 2097152 &lt;nil&gt; &lt;nil&gt; 0x2a00180 0x2a00230 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; {0x7f682ec91aa8 0x7f682ec91aa8} 0x2a00910 {0 0 0 [0 0 0 0] 0 &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0 0 0 [0 0 0 0 0]} 0 0 0 [0 0 0] {0x2b6dc10 0x2b6dc10 1 8 &lt;nil&gt; 1 [0 0 0 0 0 0 0] &lt;nil&gt;} [0x7f682f197a58 0x7f682f198ce0 0x7f682f197b38 &lt;nil&gt; &lt;nil&gt; 0x7f682f197c18] 0 1 1 [0 0 0 0 0] 0x7f682ec9544b 0x7f682ec9544b 0 0 [0 0 0 0 0 0] 0 [0 0 0 0 0 0 0 0] 1 1 1 1 1 0 1 [0] 0 [0 0 0 0] &lt;nil&gt; &lt;nil&gt; 0 [0 0 0 0] 0x2cf27c0 &lt;nil&gt; 0 0 [0 0 0 0 0 0] 64 1000 0 [0 0 0 0 0 0 0] 0x7f682ecc6270 300 0x2a009b0 1 [0 0 0 0 0 0 0] &lt;nil&gt; 0 [0 0 0 0 0 0 0]}
    sleep done
    1 back
    1 done
    sleep done
    2 back
    2 done
    1.00099211s
</code></pre><p>可以看到两个sleep 1s，最终只用了1.00099211s。说明协程是并发的。</p><p>一些性能指标。走http调用后端，在i7-6700k上，用ab -n 100 -c 4 可以跑出这样的结果</p><pre><code>Requests per second:    3183.70 [#/sec] (mean)
Time per request:       1.256 [ms] (mean)
Time per request:       0.314 [ms] (mean, across all concurrent requests)
</code></pre><p>如果不用http调用后端，直接php=&gt;go返回&rdquo;hello&rdquo;，则可以达到</p><pre><code>Requests per second:    10073.54 [#/sec] (mean)
Time per request:       0.397 [ms] (mean)
Time per request:       0.099 [ms] (mean, across all concurrent requests)
</code></pre><p>这些指标只说明了协程切换的成本。实际的收益取决于后端的http服务的延迟，如果耗时很长，通过协程并发则可以收益明显。</p><p>这个实验说明了可以用golang实现一个代替nginx+php-fpm的应用服务器。并且提供了一条从php向golang迁移的平滑迁移路径。在一个应用里混合PHP和Go两种语言。</p><p>并且可以通过提供golang函数给php调用的方式实现I/O的异步化。像libcurl这样的扩展自身是支持异步回调的，只是php是同步的所以只给php暴露了同步的execute。有了Golang之后，可以把execute变成对异步execute+callback的包装，从而实现基于协程的调度。</p><p>参考资料：</p><ul><li><p><a href="https://wiki.php.net/internals/references">https://wiki.php.net/internal&hellip;</a></p></li><li><p><a href="http://www.cunmou.com/phpbook/preface.md">http://www.cunmou.com/phpbook&hellip;</a></p></li><li><p><a href="http://www.phpinternalsbook.com/index.html">http://www.phpinternalsbook.c&hellip;</a></p></li><li><p><a href="http://www.php-internals.com/book/">http://www.php-internals.com/&hellip;</a></p></li></ul></div><aside id="meta"><meta itemprop="wordCount" content="1749"><meta itemprop="url" content="https://yushuangqi.com/blog/2016/php-hun-ge--go-xie-cheng-bing-fa.html"></aside></article><div><div class="attribution"><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a></div><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","tqq","tieba","douban","sqq","youdao","qingbiji","mail","evernotecn","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></div><div><ul class="rel_links"><li class="rel_linksli"><span id="topics">分类: <a href="/topics/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B8%8E%E5%BC%80%E5%8F%91.html" rel="category">编程语言与开发</a> </span><span id="tags">标签: <a href="/tags/coroutine.html" rel="tag">coroutine</a> <a href="/tags/golang.html" rel="tag">golang</a> <a href="/tags/php.html" rel="tag">php</a></span></li><li class="rel_linksli rel_prev"><a href="https://yushuangqi.com/blog/2016/dui-beegode-kong-zhi-qi-han-shu-jin-hang-chan-ce.html">对beego的控制器函数进行单测</a></li><li class="rel_linksli rel_next"><a href="https://yushuangqi.com/blog/2016/fen-xiang-xue-xi-goyu-yan-de-ru-men-jiao-cheng.html">分享学习GO语言的入门教程</a></li></ul></div><aside id="comments"><div><div id="cyEmoji" role="cylabs" data-use="emoji" sourceid="36f89866446ccbc2b312dbb2500a9891"></div><div id="SOHUCS" sid="36f89866446ccbc2b312dbb2500a9891"></div><script type="text/javascript">(function(){ 
var appid = 'cyt7HM6Iq'; 
var conf = 'prod_90e85fc8b207249a2493340f99075c94'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); 
}else{ 
  var loadJs=function(d,a){
    var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");
    b.setAttribute("type","text/javascript");
    b.setAttribute("charset","UTF-8");
    b.setAttribute("src",d);
    if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};
   loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })();</script><script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script><script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cyt7HM6Iq"></script></div></aside><div><section id="author"><h4>About author</h4><p><strong>虞双齐</strong>，一名全栈开发工程师，#热爱编程、#工具控、#爱读书、#宅男</p><p>动态分享到微博<a href="http://weibo.com/234665601" rel="nofollow">@虞双齐</a>，代码存放在 <a href="http://github.com/ysqi" rel="nofollow">Github</a>，博文分享在 <a href="https://yushuangqi.com" title="极客虞双齐">个人博客</a>上。</p></section></div></div></section><section id="sidebar" role="complementary"><aside class="writings"><a href="/" class="sideimg sideimgwritings">Home</a> <q class="dquote">读书之法，莫贵于循序而致精。<cite>—宋·朱熹《性理精义》</cite></q><ul class="rel_links"><li class="rel_linksli"><a href="http://weibo.com/234665601" title="关注虞双齐的微博" rel="nofollow">我的微博</a></li><li class="rel_linksli"><a href="https://github.com/ysqi" title="访问虞双齐的Github" rel="nofollow">我的 Github</a></li></ul></aside><aside><div class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div></aside></section><nav id="menu" role="navigation"><ul id="nav" class="navlist"><li class="navtop"><a class="navtoplink" href="#page"><span>Top</span></a></li><li><a class="navabout" href="https://yushuangqi.com"><span>首页</span></a></li><li><a class="navwritings" href="/topics/"><span>博文</span></a></li><li><a class="navpresos" href="/book.html"><span>电子书</span></a></li><li><a class="navabout" href="/about.html"><span>关于我</span></a></li></ul></nav></div><footer class="site-footer"><ul class="footeractions"><li><a class="footeraction" href="http://weibo.com/234665601" rel="nofollow"><span class="footeractionWeibo">Follow on Weibo</span></a></li><li><a href="http://validator.w3.org/check?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fphp-hun-ge--go-xie-cheng-bing-fa.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-html401.png" alt="Valid XHTMl 4.0"></a></li><li><a href="http://jigsaw.w3.org/css-validator/validator?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fphp-hun-ge--go-xie-cheng-bing-fa.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-css2.png" alt="Valid XHTMl 4.0"></a></li></ul><p>©2015-2016 虞双齐-爱分享的极客。欢迎<a href="/about.html" rel="nofollow">联系我</a>，<a href="http://www.miitbeian.gov.cn/" target="bank" rel="nofollow" style="color:#c9c9c9">粤ICP备14032560号-4</a></p></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-44627932-2', 'auto');
  ga('send', 'pageview');</script></body></html>