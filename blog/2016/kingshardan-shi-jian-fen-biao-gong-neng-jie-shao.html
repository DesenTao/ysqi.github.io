<!DOCTYPE html><html xmlns="https://www.w3.org/1999/xhtml" xmlns:og="https://ogp.me/ns#" lang="zh" id="doc" class="no-js"><head><title>kingshard按时间分表功能介绍 |极客虞双齐</title><meta name="description" content="kingshard按时间分表功能介绍 在文档中主要介绍了kingshard的Hash和Range方式"><meta name="keywords" content="kingshard, mysql-proxy, golang, mysql, "><meta name="author" content="虞双齐"><meta name="generator" content="Hugo 0.17"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="32x32" href="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="虞双齐"><link rel="apple-touch-icon-precomposed" href="/img/app-icon64x64.png"><meta name="msapplication-TileImage" content="/img/app-icon128x128.png"><meta name="msapplication-TileColor" content="#0e90d2"><meta property="og:site_name" content="极客虞双齐"><meta property="og:locale" content="zh"><meta property="og:url" content="https://yushuangqi.com/blog/2016/kingshardan-shi-jian-fen-biao-gong-neng-jie-shao.html"><meta property="og:title" content="kingshard按时间分表功能介绍"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-12-31 11:33:55"><meta property="article:modified_time" content="2016-12-31 11:33:55"><meta property="article:tag" content="kingshard"><meta property="article:tag" content="mysql-proxy"><meta property="article:tag" content="golang"><meta property="article:tag" content="mysql"><meta name="og:description" content="kingshard按时间分表功能介绍 在文档中主要介绍了kingshard的Hash和Range方式"><link rel="stylesheet" type="text/css" href="/css/jiandan.css?v=20170207"><script type="text/javascript">var doc = document.getElementById('doc');
	doc.removeAttribute('class', 'no-js');
	doc.setAttribute('class', 'js');</script><script type="text/javascript">var changeActive = function() {
		var page = document.getElementById("page");		
		if (page.getAttribute("class") === "not-active") {
			page.setAttribute("class", "active-sidebar");		
		} else if (page.getAttribute("class") === "active-sidebar") {
			page.setAttribute("class", "not-active");
		}		
	}
	
	window.onload = function() {
		if(document.getElementById("sidebar-button")) {
			var sidebar_button = document.getElementById("sidebar-button");
			sidebar_button.onclick = function(event) {
				changeActive();
				event.preventDefault();
			}
		}
		
	}
	
	window.onresize = function() {
		var page = document.getElementById("page");	
		page.setAttribute("class", "not-active");	
	}</script></head><body id="page" class="not-active"><div class="container"><header class="header writingsheader"><nav class="off-canvas-nav-links"><ul><li class="menuli"><a class="menubutton" href="#menu">Menu</a></li><li id="site-title"><a class="menulogo" id="sidebar-button" href="#sidebar">附件信息</a></li></ul></nav></header><section role="main"><article class="entry writingsentry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 itemprop="headline"><a rel="bookmark" href="https://yushuangqi.com/blog/2016/kingshardan-shi-jian-fen-biao-gong-neng-jie-shao.html">kingshard按时间分表功能介绍</a></h1><p class="attribution"><span itemprop="author"><span itemscope itemtype="http://schema.org/Person">文/ <a href="https://segmentfault.com/a/1190000004568853" rel="nofollow" target="_blank">属转载,查看原文 <span itemprop="name" style="display:none">虞双齐</span></a></span> </span><span class="right"><time itemprop="datePublished" datetime="2016-12-31">2016年12月31日</time></span></p></header><div itemprop="articleBody"><h1 id="kingshard按时间分表功能介绍">kingshard按时间分表功能介绍</h1><p>在<a href="https://github.com/flike/kingshard/blob/master/doc/KingDoc/how_to_use_kingshard.md">文档</a>中主要介绍了kingshard的Hash和Range方式的分表，最近又开发了按时间维度的分表方式。按时间维度分表的场景非常普遍，下面介绍一下kingshard的时间分表功能</p><ol><li>支持的时间类型 &mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</li></ol><p>kingshard中的分表字段支持MySQL中三种类型的时间格式</p><ul><li><p>date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。</p></li><li><p>datetime类型，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04,注意：2016-3-04 13:23:43，2016-03-4 13:23:43，2016-3-4 13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。</p></li><li><p>timestamp类型，整数类型，例如：1457165568，对应的是：2016-3-5 16:12:48。</p></li></ul><ol><li>支持的时间分表类型 &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</li></ol><p>kingshard支持MySQL中三种格式的时间类型</p><ul><li><p>date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。</p></li><li><p>datetime，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04,注意：2016-3-04 13:23:43，2016-03-4 13:23:43，2016-3-4 13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。</p></li><li><p>timestamp，整数类型。</p></li></ul><ol><li>功能演示 &mdash;&mdash;&mdash;&ndash;</li></ol><p>kingshard的配置文件如下所示：</p><pre><code># server listen addr
addr : 0.0.0.0:9696

# server user and password
user :  kingshard
password : kingshard

# if set log_path, the sql log will write into log_path/sql.log,the system log
# will write into log_path/sys.log
#log_path : /Users/flike/log

# log level[debug|info|warn|error],default error
log_level : debug

# if set log_sql(on|off) off,the sql log will not output
log_sql: on

# only log the query that take more than slow_log_time ms
#slow_log_time : 100

# the path of blacklist sql file
# all these sqls in the file will been forbidden by kingshard
#blacklist_sql_file: /Users/flike/blacklist

# only allow this ip list ip to connect kingshard
#allow_ips: 127.0.0.1

# the charset of kingshard, if you don't set this item
# the default charset of kingshard is utf8.
#proxy_charset: gbk

# node is an agenda for real remote mysql server.
nodes :
- 
    name : node1 

    # default max conns for mysql server
    max_conns_limit : 32

    # all mysql in a node must have the same user and password
    user :  kingshard 
    password : kingshard

    # master represents a real mysql master server 
    master : 127.0.0.1:3306

    # slave represents a real mysql salve server,and the number after '@' is 
    # read load weight of this slave.
    #slave : 192.168.59.101:3307@2,192.168.59.101:3307@3
    down_after_noalive : 32
- 
    name : node2 

    # default max conns for mysql server
    max_conns_limit : 32

    # all mysql in a node must have the same user and password
    user :  kingshard 
    password : kingshard

    # master represents a real mysql master server 
    master : 192.168.59.103:3307

    # slave represents a real mysql salve server 
    slave : 

    # down mysql after N seconds noalive
    # 0 will no down
    down_after_noalive: 32

# schema defines sharding rules, the db is the sharding table database.
schema :
    db : kingshard
    nodes: [node1,node2]
    default: node1      
    shard:
    -
       table: test_shard_year
       key: ctime
       type: date_day
       nodes: [node1,node2]
       date_range: [2015-2016,2017-2018]
</code></pre><h3 id="3-1-按年分表">3.1 按年分表</h3><h4 id="3-1-1-配置说明">3.1.1 配置说明</h4><p>按年分表的配置项设置如下：</p><pre><code>       table: test_shard_year
       key: ctime
       type: date_year
       nodes: [node1,node2]
       date_range: [2015-2016,2017-2018]
</code></pre><p>该配置表示：</p><ul><li><p>sharding key是ctime。</p></li><li><p>按年的分表类型是:<code>date_year</code>。</p></li><li><p><code>test_shard_year_2015, test_shard_year_2016</code>两个子表落在node1上，<code>test_shard_year_2017，test_shard_year_2018</code>两个子表落在node2上。</p></li><li><p>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[2015,2017-2018]</code>。</p></li></ul><p>注意：子表的命名格式必须是:shard_table_YYYY,shard_table是分表名，后面接具体的年。</p><h4 id="3-1-2-功能演示">3.1.2 功能演示</h4><p>在node1上创建两张子表<code>test_shard_year_2015, test_shard_year_2016</code>，在node2上创建两种子表<code>test_shard_year_2017，test_shard_year_2018</code>。建表SQL如下</p><pre><code>CREATE TABLE `test_shard_year_2016` (
  `id` int(10) NOT NULL,
  `name` varchar(40) DEFAULT NULL,
  `ctime` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre><p>插入数据：</p><pre><code>mysql&gt; insert into test_shard_year(id,name,ctime) values(12,&quot;hello&quot;,&quot;2015-02-22 13:23:45&quot;);
Query OK, 1 row affected (0.01 sec)

mysql&gt; insert into test_shard_year(id,name,ctime) values(13,&quot;world&quot;,&quot;2016-03-22&quot;);
Query OK, 1 row affected (0.00 sec)

mysql&gt; select * from test_shard_year where ctime &lt; &quot;2016-03-23&quot;;
+----+-------+---------------------+
| id | name  | ctime               |
+----+-------+---------------------+
| 12 | hello | 2015-02-22 13:23:45 |
| 13 | world | 2016-03-22 00:00:00 |
+----+-------+---------------------+
2 rows in set (0.00 sec)
</code></pre><p>对应的SQL log信息是：</p><pre><code>2016/03/05 12:06:32 - OK - 1.2ms - 127.0.0.1:56597-&gt;127.0.0.1:3306:insert into test_shard_year_2015(id, name, ctime) values (12, 'hello', '2015-02-22 13:23:45')
2016/03/05 12:06:59 - OK - 2.0ms - 127.0.0.1:56597-&gt;127.0.0.1:3306:insert into test_shard_year_2016(id, name, ctime) values (13, 'world', '2016-03-22')
2016/03/05 12:08:30 - OK - 1.6ms - 127.0.0.1:56597-&gt;127.0.0.1:3306:select * from test_shard_year_2015 where ctime &lt; '2016-03-23'
2016/03/05 12:08:30 - OK - 0.3ms - 127.0.0.1:56597-&gt;127.0.0.1:3306:select * from test_shard_year_2016 where ctime &lt; '2016-03-23'
</code></pre><p>当然如果你把id作为一个unix时间戳，来分表的话，kingshard也是支持的。具体配置就是这样的：</p><pre><code>       table: test_shard_year
       key: id
       type: date_year
       nodes: [node1,node2]
       date_range: [2015-2016,2017-2018]
</code></pre><p>插入数据:</p><pre><code>mysql&gt; insert into test_shard_year(id,name,ctime) values(1457410310,&quot;world&quot;,&quot;2018-03-22&quot;);
Query OK, 1 row affected (0.01 sec)

mysql&gt; select * from test_shard_year where id = 1457410310;
+------------+-------+---------------------+
| id         | name  | ctime               |
+------------+-------+---------------------+
| 1457410310 | world | 2018-03-22 00:00:00 |
+------------+-------+---------------------+
1 row in set (0.00 sec)
</code></pre><p>1457410310 这个unix时间戳对应的日期是：2016-3-8 12:11:50。kingshard准确地将这条记录路由到了<code>test_shard_year_2016</code>这张子表中了。<br>对应的SQL log是：</p><pre><code>2016/03/08 12:12:49 - OK - 1.0ms - 127.0.0.1:56669-&gt;127.0.0.1:3306:insert into test_shard_year_2016(id, name, ctime) values (1457410310, 'world', '2018-03-22')
2016/03/08 12:13:23 - OK - 0.4ms - 127.0.0.1:56669-&gt;127.0.0.1:3306:select * from test_shard_year_2016 where id = 1457410310
</code></pre><h3 id="3-2-按月分表">3.2 按月分表</h3><h4 id="配置说明">配置说明</h4><p>按月分表的配置项设置如下：</p><pre><code>       table: test_shard_month
       key: ctime
       type: date_month
       nodes: [node1,node2]
       date_range: [201512-201602,201609-2016010]
</code></pre><p>该配置表示：</p><ul><li><p>sharding key是ctime。</p></li><li><p>按年的分表类型是:<code>date_month</code>。</p></li><li><p><code>test_shard_month_201512, test_shard_month_201601, test_shard_month_201602</code>两个子表落在node1上，<code>test_shard_month_201609，test_shard_month_201610</code>两个子表落在node2上。</p></li><li><p>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[201501,201609-201610]</code>。</p></li></ul><p>注意：子表的命名格式必须是:<code>shard_table_YYYYMM,shard_table</code>是分表名，后面接具体的年和月。</p><p>功能演示参考按年分表的操作。</p><h3 id="3-3-按天分表">3.3 按天分表</h3><h4 id="配置说明-1">配置说明</h4><p>按月分表的配置项设置如下：</p><pre><code>       table: test_shard_day
       key: ctime
       type: date_day
       nodes: [node1,node2]
       date_range: [20151222-20151224,20160901-20160902]
</code></pre><p>该配置表示：</p><ul><li><p>sharding key是ctime。</p></li><li><p>按年的分表类型是:<code>date_day</code>。</p></li><li><p><code>test_shard_day_20151222, test_shard_day_20151223, test_shard_day_20151224</code>两个子表落在node1上，<code>test_shard_day_20160901，test_shard_day_20160902</code>两个子表落在node2上。</p></li><li><p>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[20150101,20160901-20161010]</code>。</p></li></ul><p>注意：子表的命名格式必须是:<code>shard_table_YYYYMMDD,shard_table</code>是分表名，后面接具体的年,月和日。</p><p>功能演示参考按年分表的操作。</p><p>kingshard开源地址：<a href="https://github.com/flike/kingshard">https://github.com/flike/kingshard</a></p></div><aside id="meta"><meta itemprop="wordCount" content="659"><meta itemprop="url" content="https://yushuangqi.com/blog/2016/kingshardan-shi-jian-fen-biao-gong-neng-jie-shao.html"></aside></article><div><div class="attribution"><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a></div><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","tqq","tieba","douban","sqq","youdao","qingbiji","mail","evernotecn","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></div><div><ul class="rel_links"><li class="rel_linksli"><span id="topics">分类: <a href="/topics/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B8%8E%E5%BC%80%E5%8F%91.html" rel="category">编程语言与开发</a> </span><span id="tags">标签: <a href="/tags/golang.html" rel="tag">golang</a> <a href="/tags/kingshard.html" rel="tag">kingshard</a> <a href="/tags/mysql.html" rel="tag">mysql</a> <a href="/tags/mysql-proxy.html" rel="tag">mysql-proxy</a></span></li><li class="rel_linksli rel_prev"><a href="https://yushuangqi.com/blog/2016/golang-ban-ben-de--ring-buffer-bian-chang-chi-jiu-hua-.html">golang版本的ringbuffer(变长持久化)</a></li><li class="rel_linksli rel_next"><a href="https://yushuangqi.com/blog/2016/yi-ge-shi-xian--twitter-snowflake-suan-fa--de--go-fen-bu-shi--uid-sheng-cheng-qi.html">一个实现TwitterSnowFlake算法的Go分布式UID生成器</a></li></ul></div><aside id="comments"><div><div id="cyEmoji" role="cylabs" data-use="emoji" sourceid="a5d076deaeb811f025b5d71086c2a710"></div><div id="SOHUCS" sid="a5d076deaeb811f025b5d71086c2a710"></div><script type="text/javascript">(function(){ 
var appid = 'cyt7HM6Iq'; 
var conf = 'prod_90e85fc8b207249a2493340f99075c94'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); 
}else{ 
  var loadJs=function(d,a){
    var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");
    b.setAttribute("type","text/javascript");
    b.setAttribute("charset","UTF-8");
    b.setAttribute("src",d);
    if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};
   loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })();</script><script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script><script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cyt7HM6Iq"></script></div></aside><div><section id="author"><h4>About author</h4><p><strong>虞双齐</strong>，一名全栈开发工程师，#热爱编程、#工具控、#爱读书、#宅男</p><p>动态分享到微博<a href="http://weibo.com/234665601" rel="nofollow">@虞双齐</a>，代码存放在 <a href="http://github.com/ysqi" rel="nofollow">Github</a>，博文分享在 <a href="https://yushuangqi.com" title="极客虞双齐">个人博客</a>上。</p></section></div></div></section><section id="sidebar" role="complementary"><aside class="writings"><a href="/" class="sideimg sideimgwritings">Home</a> <q class="dquote">读书之法，莫贵于循序而致精。<cite>—宋·朱熹《性理精义》</cite></q><ul class="rel_links"><li class="rel_linksli"><a href="http://weibo.com/234665601" title="关注虞双齐的微博" rel="nofollow">我的微博</a></li><li class="rel_linksli"><a href="https://github.com/ysqi" title="访问虞双齐的Github" rel="nofollow">我的 Github</a></li></ul></aside><aside><div class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div></aside></section><nav id="menu" role="navigation"><ul id="nav" class="navlist"><li class="navtop"><a class="navtoplink" href="#page"><span>Top</span></a></li><li><a class="navabout" href="https://yushuangqi.com"><span>首页</span></a></li><li><a class="navwritings" href="/topics/"><span>博文</span></a></li><li><a class="navpresos" href="/book.html"><span>电子书</span></a></li><li><a class="navabout" href="/about.html"><span>关于我</span></a></li></ul></nav></div><footer class="site-footer"><ul class="footeractions"><li><a class="footeraction" href="http://weibo.com/234665601" rel="nofollow"><span class="footeractionWeibo">Follow on Weibo</span></a></li><li><a href="http://validator.w3.org/check?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fkingshardan-shi-jian-fen-biao-gong-neng-jie-shao.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-html401.png" alt="Valid XHTMl 4.0"></a></li><li><a href="http://jigsaw.w3.org/css-validator/validator?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fkingshardan-shi-jian-fen-biao-gong-neng-jie-shao.html" rel="nofollow" target="blank"><img src="https://static.yushuangqi.com//assets/valid-css2.png" alt="Valid XHTMl 4.0"></a></li></ul><p>©2015-2016 虞双齐-爱分享的极客。欢迎<a href="/about.html" rel="nofollow">联系我</a>，<a href="http://www.miitbeian.gov.cn/" target="bank" rel="nofollow" style="color:#c9c9c9">粤ICP备14032560号-4</a></p></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-44627932-2', 'auto');
  ga('send', 'pageview');</script></body></html>