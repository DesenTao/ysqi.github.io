<!DOCTYPE html><html xmlns="https://www.w3.org/1999/xhtml" xmlns:og="https://ogp.me/ns#" lang="zh" id="doc" class="no-js"><head><title>使用go的io_Pipe优雅的优化中间缓存 |虞双齐的博客</title><meta name="description" content="BEFORE 今天发现，go的优势除了它的轻量线程(goroutine)提供了更方便灵活的并发编程模"><meta name="keywords" content="performance, pipe, io, golang, "><meta name="author" content="虞双齐"><meta name="generator" content="Hugo 0.31.1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="32x32" href="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="虞双齐"><link rel="apple-touch-icon-precomposed" href="/img/app-icon64x64.png"><meta name="msapplication-TileImage" content="/img/app-icon128x128.png"><meta name="msapplication-TileColor" content="#0e90d2"><meta property="og:site_name" content="虞双齐的博客"><meta property="og:locale" content="zh"><meta property="og:url" content="https://yushuangqi.com/blog/2016/shi-yong-gode-io_pipeyou-ya-de-you-hua-zhong-jian-huan-cun.html"><meta property="og:title" content="使用go的io_Pipe优雅的优化中间缓存"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-12-31 11:33:00"><meta property="article:modified_time" content="2016-12-31 11:33:00"><meta property="article:tag" content="performance"><meta property="article:tag" content="pipe"><meta property="article:tag" content="io"><meta property="article:tag" content="golang"><meta name="og:description" content="BEFORE 今天发现，go的优势除了它的轻量线程(goroutine)提供了更方便灵活的并发编程模"><link rel="stylesheet" type="text/css" href="/css/jiandan.css?v=201709"><script type="text/javascript">var doc = document.getElementById('doc');
	doc.removeAttribute('class', 'no-js');
	doc.setAttribute('class', 'js');</script><script type="text/javascript">var changeActive = function() {
		var page = document.getElementById("page");		
		if (page.getAttribute("class") === "not-active") {
			page.setAttribute("class", "active-sidebar");		
		} else if (page.getAttribute("class") === "active-sidebar") {
			page.setAttribute("class", "not-active");
		}		
	}
	
	window.onload = function() {
		if(document.getElementById("sidebar-button")) {
			var sidebar_button = document.getElementById("sidebar-button");
			sidebar_button.onclick = function(event) {
				changeActive();
				event.preventDefault();
			}
		}
		
	}
	
	window.onresize = function() {
		var page = document.getElementById("page");	
		page.setAttribute("class", "not-active");	
	}</script></head><body id="page" class="not-active"><div class="container"><header class="header writingsheader"><nav class="off-canvas-nav-links"><ul><li class="menuli"><a class="menubutton" href="#menu">Menu</a></li><li id="site-title"><a class="menulogo" id="sidebar-button" href="#sidebar">附件信息</a></li></ul></nav></header><section role="main"><article class="entry writingsentry" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 itemprop="headline"><a rel="bookmark" href="https://yushuangqi.com/blog/2016/shi-yong-gode-io_pipeyou-ya-de-you-hua-zhong-jian-huan-cun.html">使用go的io_Pipe优雅的优化中间缓存</a></h1><p class="attribution"><span itemprop="author"><span itemscope itemtype="http://schema.org/Person">文/ <a href="https://segmentfault.com/a/1190000007172011" rel="nofollow" target="_blank">属转载,查看原文 <span itemprop="name" style="display:none">虞双齐</span></a></span> </span><span class="right"><time itemprop="datePublished" datetime="2016-12-31">2016年12月31日</time></span></p></header><div itemprop="articleBody"><h3 id="before">BEFORE</h3><p>今天发现，go的优势除了它的轻量线程(goroutine)提供了更方便灵活的并发编程模式之外，它的I/O机制也设计的非常给力。</p><p>之前，我在向其他服务器发送json数据时，都需要先声明一个<code>bytes</code>缓存，然后通过<code>json</code>库把结构体中的内容mashal成字节流，再通过Post函数发送。<br>代码如下：</p><pre><code>package main

import (
        &quot;bytes&quot;
        &quot;encoding/json&quot;
        &quot;io/ioutil&quot;
        &quot;log&quot;
        &quot;net/http&quot;
)

func init() {
        log.SetFlags(log.Lshortfile)
}

func main() {
        cli := http.Client{}

        msg := struct {
            Name, Addr string
            Price      float64
        }{
            Name:  &quot;hello&quot;,
            Addr:  &quot;beijing&quot;,
            Price: 123.56,
        }
        buf := bytes.NewBuffer(nil)
        json.NewEncoder(buf).Encode(msg)
        resp, err := cli.Post(&quot;http://localhost:9999/json&quot;, &quot;application/json&quot;, buf)

        if err != nil {
            log.Fatalln(err)
        }

        body := resp.Body
        defer body.Close()

        if body_bytes, err := ioutil.ReadAll(body); err == nil {
            log.Println(&quot;response:&quot;, string(body_bytes))
        } else {
            log.Fatalln(err)
        }
}
</code></pre><p>这样就总是需要我们在内存中预先分配一个缓存，大部分情况下其实还好，<strong>BUT</strong> 如果需要发送的数据很大，就会严重影响性能了。</p><h3 id="after">AFTER</h3><p>go设计了一个Pipe函数帮我们解决这个问题，于是我的代码可以改为：</p><pre><code>package main

import (
        &quot;encoding/json&quot;
        &quot;io&quot;
        &quot;io/ioutil&quot;
        &quot;log&quot;
        &quot;net/http&quot;
        &quot;time&quot;
)

func init() {
        log.SetFlags(log.Lshortfile)
}
func main() {
        cli := http.Client{}

        msg := struct {
            Name, Addr string
            Price      float64
        }{
            Name:  &quot;hello&quot;,
            Addr:  &quot;beijing&quot;,
            Price: 123.56,
        }
        r, w := io.Pipe()
        // 注意这边的逻辑！！
        go func() {
            defer func() {
                time.Sleep(time.Second * 2)
                log.Println(&quot;encode完成&quot;)
                // 只有这里关闭了，Post方法才会返回
                w.Close()
            }()
            log.Println(&quot;管道准备输出&quot;)
            // 只有Post开始读取数据，这里才开始encode，并传输
            err := json.NewEncoder(w).Encode(msg)
            log.Println(&quot;管道输出数据完毕&quot;)
            if err != nil {
                log.Fatalln(&quot;encode json failed:&quot;, err)
            }
        }()
        time.Sleep(time.Second * 1)
        log.Println(&quot;开始从管道读取数据&quot;)
        resp, err := cli.Post(&quot;http://localhost:9999/json&quot;, &quot;application/json&quot;, r)

        if err != nil {
            log.Fatalln(err)
        }
        log.Println(&quot;POST传输完成&quot;)

        body := resp.Body
        defer body.Close()

        if body_bytes, err := ioutil.ReadAll(body); err == nil {
            log.Println(&quot;response:&quot;, string(body_bytes))
        } else {
            log.Fatalln(err)
        }
}
</code></pre><p>输出如下：</p><pre><code>main.go:35: 管道准备输出
main.go:44: 开始从管道读取数据
main.go:38: 管道输出数据完毕
main.go:31: encode完成
main.go:50: POST传输完成
main.go:56: response: {&quot;Name&quot;:&quot;hello&quot;,&quot;Addr&quot;:&quot;beijing&quot;,&quot;Price&quot;:123.56}
</code></pre><p>可以看到，通过Pipe，我们可以方便的链接输入和输出，只要我们能正确理解整个过程的逻辑。有了它，我们终于可以甩去讨厌的中间缓存了，同时也提高了系统的稳定性。</p><h3 id="服务器端代码">服务器端代码</h3><p>为了方便大家调试，以下是服务器端代码：</p><pre><code>package main

import (
           &quot;encoding/json&quot;
           &quot;io/ioutil&quot;
           &quot;log&quot;
           &quot;net/http&quot;
)

func init() {
           log.SetFlags(log.Lshortfile)
}

func main() {
           http.HandleFunc(&quot;/json&quot;, handleJson)

           http.ListenAndServe(&quot;:9999&quot;, nil)
}

func handleJson(resp http.ResponseWriter, req *http.Request) {
           if req.Method == &quot;POST&quot; {
               body := req.Body
               defer body.Close()
               body_bytes, err := ioutil.ReadAll(body)
               if err != nil {
                   log.Println(err)
                   resp.Write([]byte(err.Error()))
                   return
               }
               j := map[string]interface{}{}
               if err := json.Unmarshal(body_bytes, &amp;j); err != nil {
                   log.Println(err)
                   resp.Write([]byte(err.Error()))
                   return
               }
               resp.Write(body_bytes)
           } else {
               resp.Write([]byte(&quot;请使用post方法!&quot;))
           }
}
</code></pre></div><aside id="meta"><meta itemprop="wordCount" content="293"><meta itemprop="url" content="https://yushuangqi.com/blog/2016/shi-yong-gode-io_pipeyou-ya-de-you-hua-zhong-jian-huan-cun.html"></aside></article><div><div class="attribution"><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_mshare" data-cmd="mshare" title="分享到一键分享"></a></div><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","qzone","tsina","bdysc","weixin","tqq","tieba","douban","sqq","youdao","qingbiji","mail","evernotecn","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></div><div><ul class="rel_links"><li class="rel_linksli"><span id="topics">分类: <a href="/topics/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B8%8E%E5%BC%80%E5%8F%91.html" rel="category">编程语言与开发</a> </span><span id="tags">标签: <a href="/tags/golang.html" rel="tag">golang</a> <a href="/tags/io.html" rel="tag">io</a> <a href="/tags/performance.html" rel="tag">performance</a> <a href="/tags/pipe.html" rel="tag">pipe</a></span></li><li class="rel_linksli rel_prev"><a href="https://yushuangqi.com/blog/2016/interfaces-and-composition-for-effective-unit-testing-in-golang.html">InterfacesandCompositionforEffectiveUnitTestinginGolang</a></li><li class="rel_linksli rel_next"><a href="https://yushuangqi.com/blog/2016/ru-men-goroutinebing-fa-she-ji-mo-shi-yi-ji-goroutineke-shi-hua-gong-ju.html">入门goroutine并发设计模式以及goroutine可视化工具</a></li></ul></div><aside id="comments"><div><div id="cyEmoji" role="cylabs" data-use="emoji" sid="f166511cd334290ab7068d4fb43b2892"></div><div id="cyReward" role="cylabs" data-use="reward" sid="f166511cd334290ab7068d4fb43b2892" style="text-align:center"></div><div id="SOHUCS" sid="f166511cd334290ab7068d4fb43b2892"></div><script type="text/javascript">(function(){ 
var appid = 'cyt7HM6Iq'; 
var conf = 'prod_90e85fc8b207249a2493340f99075c94'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); 
}else{ 
  var loadJs=function(d,a){
    var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");
    b.setAttribute("type","text/javascript");
    b.setAttribute("charset","UTF-8");
    b.setAttribute("src",d);
    if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};
   loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })();</script><script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script><script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cyt7HM6Iq"></script></div></aside></div></section><section id="sidebar" role="complementary"><aside class="writings"><a href="/" class="sideimg sideimgwritings">Home</a> <q class="dquote">读书之法，莫贵于循序而致精。<cite>—宋·朱熹《性理精义》</cite></q><ul class="rel_links"><li class="rel_linksli"><a href="http://weibo.com/234665601" title="关注虞双齐的微博" rel="nofollow">我的微博</a></li><li class="rel_linksli"><a href="https://github.com/ysqi" title="访问虞双齐的Github" rel="nofollow">我的 Github</a></li><li class="rel_linksli"><a href="https://www.zhihu.com/people/_ysqi" title="访问虞双齐的知乎" rel="nofollow">我的 知乎</a></li></ul></aside><aside><div class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div></aside></section><nav id="menu" role="navigation"><ul id="nav" class="navlist"><li class="navtop"><a class="navtoplink" href="#page"><span>Top</span></a></li><li><a class="navabout" href="https://yushuangqi.com"><span>首页</span></a></li><li><a class="navwritings" href="/topics.html"><span>博文</span></a></li><li><a class="navpresos" href="/book.html"><span>电子书</span></a></li><li><a class="navabout" href="/about.html"><span>关于我</span></a></li></ul></nav></div><footer class="site-footer"><ul class="footeractions"><li><a class="footeraction" href="http://weibo.com/234665601" rel="nofollow" title="在微博关注 虞双齐"><span class="footeractionWeibo">Weibo</span></a></li><li><a class="footeraction" href="https://www.zhihu.com/people/_ysqi" rel="nofollow" title="在微博关注 虞双齐"><span class="footeractionZhiHu">知乎</span></a></li><li><a class="footeraction" href="/index.xml" title="RSS订阅 虞双齐"><span class="footeractionRSS">Feed</span></a></li><li><a class="footeraction" href="http://validator.w3.org/check?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fshi-yong-gode-io_pipeyou-ya-de-you-hua-zhong-jian-huan-cun.html" rel="nofollow" target="blank"><span class="footeractionW3CHTML">Valid XHTMl 4.0</span></a></li><li><a class="footeraction" href="http://jigsaw.w3.org/css-validator/validator?uri=https%3a%2f%2fyushuangqi.com%2fblog%2f2016%2fshi-yong-gode-io_pipeyou-ya-de-you-hua-zhong-jian-huan-cun.html" rel="nofollow" target="blank"><span class="footeractionW3CCSS">Valid CSS Leval2</span></a></li></ul><p>©2015-2016 虞双齐-全栈开发。欢迎<a href="/about.html" rel="nofollow">联系我</a>，<a href="http://www.miitbeian.gov.cn/" target="bank" rel="nofollow" style="color:#c9c9c9">粤ICP备14032560号-4</a></p></footer><script>var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?a16b3275b071ec0efc507a05422a7156";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();</script></body></html>